<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Valeria ¬∑ Seguridad Alimentaria</title>
  <meta name="description" content="Asistente Valeria - Seguridad Alimentaria" />
  <link rel="icon" href="/favicon.jpg" />
  <style>
    :root{ --brand:#0a2f73; --bg:#f6f7fb; --fg:#0f172a; --muted:#64748b; --va:#eaf2ff; --us:#e8f5e9; --card:#fff; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--fg); display:flex; flex-direction:column }
    header{ position:sticky; top:0; background:var(--brand); color:#fff; display:flex; gap:12px; align-items:center; padding:10px 12px; z-index:10 }
    header img{ width:40px; height:40px; border-radius:50%; object-fit:cover; cursor:pointer }
    main{ flex:1; overflow:auto; padding:14px; display:flex; flex-direction:column; gap:10px }
    .msg{ max-width:860px; padding:12px 14px; border-radius:16px; line-height:1.45; box-shadow:0 1px 0 rgba(15,23,42,.04) }
    .va{ align-self:flex-start; background:var(--va) }
    .us{ align-self:flex-end; background:var(--us) }
    form{ display:flex; gap:10px; padding:10px; background:var(--card); border-top:1px solid #e2e8f0 }
    textarea{ flex:1; border:1px solid #cbd5e1; border-radius:14px; padding:10px 12px; font-size:14px; resize:none; max-height:180px }
    .send{ border:0; background:var(--brand); color:#fff; border-radius:12px; padding:0 12px; font-size:18px; cursor:pointer }
    .profile{ position:fixed; top:64px; left:50%; transform:translateX(-50%); background:var(--card); border-radius:16px; box-shadow:0 12px 28px rgba(15,23,42,.18); padding:18px; display:none; z-index:50; width:min(560px,92vw) }
    .disclaimer{ color:var(--muted); font-size:12px }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px }
    .chip{ background:#eef2ff; border:1px solid #dbeafe; border-radius:999px; padding:6px 10px; font-size:12px; cursor:pointer }
  </style>
</head>
<body>
  <header>
    <img id="avatar" src="/valeria-mini.jpg" alt="Valeria" title="Abrir perfil" />
    <div>
      <div style="font-weight:700">Valeria</div>
      <div style="font-size:12px;opacity:.95">Seguridad Alimentaria</div>
    </div>
  </header>

  <main id="chat"></main>
  <form id="form">
    <textarea id="input" rows="1" placeholder="Ej.: ¬øC√≥mo sanitizo correctamente? ¬∑ POES carnicer√≠a ¬∑ Recepci√≥n de perecederos"></textarea>
    <button class="send" aria-label="Enviar">‚û§</button>
  </form>

  <!-- Perfil expandible -->
  <div id="profile" class="profile">
    <div style="display:flex;gap:14px;align-items:center">
      <img src="/valeria-full.jpg" alt="Valeria" style="width:88px;height:88px;border-radius:50%;object-fit:cover" />
      <div>
        <h3 style="margin:6px 0 4px">Valeria ¬∑ Seguridad Alimentaria</h3>
        <div class="disclaimer">Respondo con base documental interna (procedimientos, POES, manuales, registros) y reglas operativas acordadas. Solo seguridad alimentaria/BPM/CAA.</div>
        <div class="chips" id="chips"></div>
      </div>
    </div>
  </div>

  <script>
  // ===== Utilidades =====
  const $ = s => document.querySelector(s);
  const chat = $('#chat'), form = $('#form'), input = $('#input');
  const profile = $('#profile'), avatar = $('#avatar');

  function addMsg(html, who='va'){
    const d=document.createElement('div');
    d.className='msg '+(who==='va'?'va':'us');
    d.innerHTML=html.replace(/\n/g,'<br>');
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
  }
  function norm(s){ return s.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,''); }

  // Perfil: abre/cierra
  let open=false;
  avatar.onclick=()=>{ open=!open; profile.style.display=open?'block':'none'; };
  document.addEventListener('keydown',e=>{ if(e.key==='Escape'){ open=false; profile.style.display='none'; }});
  document.addEventListener('click',e=>{ if(open && !profile.contains(e.target) && e.target!==avatar){ open=false; profile.style.display='none'; }});

  // Intro + chips
  setTimeout(()=>{ if(chat.children.length===0){ addMsg('üëã Hola, soy <b>Valeria</b>. ¬øEn qu√© te puedo ayudar hoy?'); }}, 1500);
  const SUG = ['¬øC√≥mo sanitizo correctamente?','POES carnicer√≠a','Fraccionamiento de quesos','Recepci√≥n de perecederos','Gesti√≥n de reclamos','Retiro del mercado'];
  const chips = $('#chips');
  SUG.forEach(s=>{ const c=document.createElement('div'); c.className='chip'; c.textContent=s; c.onclick=()=>{input.value=s; form.requestSubmit();}; chips.appendChild(c); });

  // ===== Reglas operativas (prioridad) =====
  function ruleDominio(q){
    const ok = /(bpm|poes|proced|sanit|desinfect|j-512|amonio|recepcion|decomiso|retiro|reclamo|temperatura|rotulado|fraccion|dulce|queso|pollo|carne|milanesa|mip|\b5s\b|plan de accion|caa|codigo alimentario|limpieza|desengrasante|camara|cocina|comedor|panader|reposter|trastienda|fruta|verdura|fiambre|lacteo|mobiliario|utensilio|residuo|transporte|perecedero|muestra|reservorio|agua de red)/.test(q);
    return ok ? null : '‚ö†Ô∏è Solo puedo ayudarte con <b>seguridad alimentaria, BPM/CAA o procedimientos internos</b>.';
  }
  function ruleSanitizacion(q){
    if(!/(sanit|desinfect|j-512|amonio|qac)/.test(q)) return null;
    return `üõ°Ô∏è <b>Sanitizaci√≥n = paso final</b>. Antes hac√© la <b>limpieza completa</b>: retirar residuos ‚Üí pre-enjuague ‚Üí <b>desengrasante</b> ‚Üí fregado ‚Üí enjuague final. Luego aplic√° <b>J-512 a 200 ppm</b> con <b>dilutor</b> (manual solo si falla) y verific√° con <b>tiras QAC</b> (50/100/200/400 ppm).`;
  }
  function ruleQuesos(q){
    if(!/(ques|horma|fraccion)/.test(q)) return null;
    return `üßÄ <b>Sobrante de quesos ‚â† consumo interno</b>. Resguardar a <b>0‚Äì5 ¬∞C</b>, <b>resinitar</b> y <b>etiquetar</b> (fraccionado, vencimiento, lote, peso, conservaci√≥n). Tolerancia <b>5 d√≠as</b> para fraccionado definitivo con <b>control diario</b>.`;
  }

  // ===== RAG (Netlify Function) =====
  async function callVector(q){
    try{
      const r = await fetch('/.netlify/functions/chat', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ query: q })
      });
      if(!r.ok) return null;
      const d = await r.json();
      return d && d.answer ? d.answer : null;
    }catch(e){ return null; }
  }

  // ===== Fallback a PDFs por alias (por si el RAG a√∫n no est√° listo) =====
  const DOCS = {
    'poes carniceria':'poes sector carniceria.pdf',
    'poes pollos':'poes sector pollos.pdf',
    'poes panaderia':'poes sector panaderia.pdf',
    'poes reposteria':'poes sector reposteria.pdf',
    'poes rotiseria':'poes sector rotiseria.pdf',
    'poes frutas y verduras':'poes sector frutas y verduras.pdf',
    'poes ba√±os y vestuarios':'poes sector ba√±os y vestuarios.pdf',
    'poes camaras':'poes camaras.pdf',
    'poes trastienda':'poes trastienda.pdf',
    'poes comedor':'poes general comedor.pdf',
    'poes cocina':'poes general cocina.pdf',
    'poes mobiliarios':'poes mobiliarios.pdf',
    'poes utensilios':'poes utensilios general.pdf',
    'poes elementos de limpieza':'poes general elementos de limpieza.pdf',
    'recepcion de mercaderia':'recepcion de mercaderia.pdf',
    'recepcion de perecederos':'recepcion de perecederos y decomisos.pdf',
    'registro de recepcion':'registro de recepcion de mercaderia.pdf',
    'retiro del mercado':'retiro de alimentos del mercado.pdf',
    'decomiso':'decomiso de mercaderia.pdf',
    'gestion de reclamos':'gestion de reclamos.pdf',
    'plan de accion':'plan de accion.pdf',
    'temperatura carne picada':'temperatura de carne picada.pdf',
    'termometro pinche':'medicion de temperatura con termometro pinche.pdf',
    'control de agua de red':'control de agua de red.pdf',
    'reservorio':'higiene de reservorio de agua fria.pdf',
    'muestras de agua':'instructivo de toma de muestras de agua.pdf',
    'sanitizante':'medicion de sanitizante.pdf',
    'procedimiento de sanitizantes':'procedimiento de sanitizantes.pdf',
    'fraccionamiento de quesos':'fraccionamiento de quesos.pdf',
    'fraccionamiento de dulces':'fraccionamiento de dulces.pdf',
    'etiquetado de hormas':'etiquetado de hormas fraccionadas.pdf',
    'etiqueta proximo a vencer':'uso de etiqueta proximo a vencer.pdf',
    'transporte de perecederos':'transporte de perecederos.pdf',
    'compra y distribucion de perecederos':'compra y distribucion de productos perecederos.pdf',
    '5s':'metodologia 5s.pdf',
    'mip':'manual mip o manejo integrado de plagas.pdf'
  };
  function normInc(s){ return s ? norm(s) : ''; }
  function docLinkByAlias(q){
    const nq = norm(q);
    for(const k in DOCS){
      if(nq.includes(norm(k))) return `/docs/${encodeURIComponent(DOCS[k])}`;
    }
    return null;
  }

  // ===== Pipeline de respuesta =====
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const qRaw = input.value.trim(); if(!qRaw) return;
    addMsg(qRaw, 'us'); input.value='';

    const q = norm(qRaw);

    // 1) Dominio
    const dom = ruleDominio(q); if(dom){ addMsg(dom); return; }

    // 2) Reglas prioritarias
    const rs = ruleSanitizacion(q); if(rs){ addMsg(rs); return; }
    const rq = ruleQuesos(q); if(rq){ addMsg(rq); return; }

    // 3) RAG (Netlify)
    const rag = await callVector(qRaw);
    if(rag){ addMsg(rag); return; }

    // 4) Fallback a PDF por alias
    const link = docLinkByAlias(qRaw);
    if(link){ addMsg(`‚úÖ <a href="${link}">Abrir PDF</a>`); return; }

    addMsg('No encontr√© un documento directo para esa consulta. Prob√° con: "POES carnicer√≠a", "Recepci√≥n de perecederos", "Fraccionamiento de quesos".');
  });
  </script>
</body>
</html>