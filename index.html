<!DOCTYPE html>
<html lang="es-AR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Valeria ¬∑ Seguridad Alimentaria</title>
  <style>
    :root {
      --header-bg: #0b66c3;
      --app-bg: #f5f7fb;
      --bubble-user: #20262e;
      --bubble-user-text: #ffffff;
      --bubble-bot: #ffffff;
      --bubble-bot-text: #0f172a;
      --border: #e5e7eb;
      --muted: #6b7280;
      --accent: #0b66c3;
      --card-bg: #f9fafb;
      --textarea-bg: #ffffff;
    }
    .dark {
      --app-bg: #0f172a;
      --bubble-user: #1f2937;
      --bubble-user-text: #e5e7eb;
      --bubble-bot: #111827;
      --bubble-bot-text: #e5e7eb;
      --border: #374151;
      --muted: #9ca3af;
      --card-bg: #0b1220;
      --textarea-bg: #0b1220;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: system-ui, sans-serif; background: var(--app-bg); color: var(--bubble-bot-text); }

    /* Header estilo WhatsApp */
    .header { position: sticky; top: 0; z-index: 10; display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: var(--header-bg); color: #fff; }
    .avatar-mini { width: 38px; height: 38px; border-radius: 999px; overflow: hidden; flex: 0 0 auto; border: 2px solid rgba(255,255,255,0.35); cursor: pointer; }
    .avatar-mini img { width: 100%; height: 100%; object-fit: cover; }
    .title-wrap { display: flex; flex-direction: column; line-height: 1.1; }
    .title { font-weight: 700; font-size: 16px; }
    .subtitle { font-size: 12px; opacity: 0.9; }
    .header-actions { margin-left: auto; display: flex; align-items: center; gap: 10px; }
    .toggle { width: 40px; height: 24px; border-radius: 999px; position: relative; background: rgba(255,255,255,0.35); cursor: pointer; }
    .toggle .knob { position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; border-radius: 50%; background: #fff; transition: all .2s ease; }
    .toggle.active .knob { left: 18px; }

    /* Chat layout */
    .chat { display: flex; flex-direction: column; height: calc(100vh - 58px); }
    .messages { flex: 1 1 auto; overflow-y: auto; padding: 12px; scroll-behavior: smooth; }
    .row { display: flex; margin-bottom: 10px; }
    .row.user { justify-content: flex-end; }
    .row.bot { justify-content: flex-start; }
    .bubble { max-width: min(85%, 720px); padding: 10px 12px; border-radius: 16px; line-height: 1.35; font-size: 15px; border: 1px solid var(--border); white-space: pre-wrap; word-wrap: break-word; overflow-wrap: anywhere; }
    .row.user .bubble { background: var(--bubble-user); color: var(--bubble-user-text); border-color: transparent; border-bottom-right-radius: 6px; }
    .row.bot .bubble { background: var(--bubble-bot); color: var(--bubble-bot-text); border-bottom-left-radius: 6px; }

    /* Adjuntos compactos */
    .attachments { margin-top: 6px; display: grid; grid-template-columns: 1fr; gap: 6px; }
    .attach-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; }
    .attach-title { font-weight: 600; margin-bottom: 4px; display: flex; gap: 6px; align-items: center; }
    .attach-meta { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .attach-actions a { display: inline-block; text-decoration: none; padding: 6px 10px; border-radius: 10px; border: 1px solid var(--accent); color: var(--accent); font-weight: 600; font-size: 13px; }

    /* Input fijo abajo */
    .composer { flex: 0 0 auto; border-top: 1px solid var(--border); background: var(--app-bg); padding: 10px 10px 12px; }
    .composer-wrap { display: flex; align-items: flex-end; gap: 8px; background: var(--textarea-bg); border: 1px solid var(--border); border-radius: 14px; padding: 8px; }
    .composer textarea { flex: 1 1 auto; resize: none; border: none; outline: none; background: transparent; color: inherit; font: inherit; max-height: 200px; min-height: 22px; }
    .send-btn { width: 40px; height: 40px; border-radius: 10px; border: none; background: var(--accent); color: #fff; display: grid; place-items: center; cursor: pointer; }
    .send-btn svg { width: 20px; height: 20px; }

    /* Modal avatar expandido */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 50; padding: 20px; }
    .modal.open { display: flex; }
    .modal-card { position: relative; max-width: 480px; width: 100%; background: #000; border-radius: 14px; overflow: hidden; }
    .modal-card img { width: 100%; display: block; }
    .modal-caption { position: absolute; left: 0; right: 0; bottom: 0; background: linear-gradient(transparent, rgba(0,0,0,0.75)); color: #fff; padding: 12px 14px; }
    .modal-caption .line1 { font-weight: 700; }
    .modal-caption .line2 { margin-top: 4px; opacity: 0.95; }
    .modal-close { position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.15); color: #fff; border: none; border-radius: 999px; width: 32px; height: 32px; cursor: pointer; font-size: 18px; display: grid; place-items: center; }

    a { color: var(--accent); }
    b { font-weight: 700; }
  </style>
</head>
<body>
  <div class="header">
    <div class="avatar-mini" id="avatarMini" title="Ver perfil">
      <img src="assets/valeria-mini.jpg" alt="Valeria mini" />
    </div>
    <div class="title-wrap">
      <div class="title">Valeria</div>
      <div class="subtitle">Seguridad Alimentaria</div>
    </div>
    <div class="header-actions">
      <div class="toggle" id="themeToggle" title="D√≠a / Noche">
        <div class="knob"></div>
      </div>
    </div>
  </div>

  <div class="chat">
    <div class="messages" id="messages"></div>
    <div class="composer">
      <div class="composer-wrap">
        <textarea id="input" rows="1" placeholder="Mensaje"></textarea>
        <button class="send-btn" id="sendBtn" aria-label="Enviar">
          <svg viewBox="0 0 24 24" fill="none"><path d="M4 12l16-8-4 8 4 8-16-8z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>
        </button>
      </div>
    </div>
  </div>

  <div class="modal" id="avatarModal" aria-hidden="true">
    <div class="modal-card">
      <img src="assets/valeria-full.jpg" alt="Valeria perfil completo" />
      <div class="modal-caption">
        <div class="line1">Valeria ¬∑ Seguridad Alimentaria</div>
        <div class="line2">üõ°Ô∏è La inocuidad alimentaria empieza con cada decisi√≥n que tomamos.</div>
      </div>
      <button class="modal-close" id="modalClose" aria-label="Cerrar">√ó</button>
    </div>
  </div>
  <script>
    // ---------------------------
    // Tema D√≠a/Noche con memoria
    // ---------------------------
    const themeToggle = document.getElementById('themeToggle');
    function setTheme(mode) {
      if (mode === 'noche') {
        document.body.classList.add('dark');
        themeToggle.classList.add('active');
        localStorage.setItem('valeria_theme', 'noche');
      } else {
        document.body.classList.remove('dark');
        themeToggle.classList.remove('active');
        localStorage.setItem('valeria_theme', 'dia');
      }
      // pista opcional para el motor de contexto
      window.__VALERIA_STATE = window.__VALERIA_STATE || {};
      window.__VALERIA_STATE.ultimo_modo = mode;
    }
    themeToggle.addEventListener('click', () => {
      const isDark = document.body.classList.contains('dark');
      setTheme(isDark ? 'dia' : 'noche');
    });
    setTheme(localStorage.getItem('valeria_theme') || 'dia');

    // ---------------------------
    // Avatar expandido
    // ---------------------------
    const avatarMini = document.getElementById('avatarMini');
    const avatarModal = document.getElementById('avatarModal');
    const modalClose = document.getElementById('modalClose');
    function openModal() { avatarModal.classList.add('open'); avatarModal.setAttribute('aria-hidden','false'); }
    function closeModal() { avatarModal.classList.remove('open'); avatarModal.setAttribute('aria-hidden','true'); }
    avatarMini.addEventListener('click', openModal);
    modalClose.addEventListener('click', closeModal);
    avatarModal.addEventListener('click', (e)=>{ if(e.target===avatarModal) closeModal(); });

    // ---------------------------
    // Utilidades UI
    // ---------------------------
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');

    function autoResizeTextarea(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 200) + 'px';
    }
    inputEl.addEventListener('input', () => autoResizeTextarea(inputEl));
    autoResizeTextarea(inputEl);

    function scrollToBottom() {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function sanitize(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.textContent;
    }

    function renderMessage({ html, text, sender, attachments }) {
      const row = document.createElement('div');
      row.className = 'row ' + (sender === 'user' ? 'user' : 'bot');

      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      if (html) {
        bubble.innerHTML = html;
      } else if (text) {
        bubble.textContent = text;
      }

      // Adjuntos compactos ‚úîÔ∏è (solo para bot)
      if (sender !== 'user' && Array.isArray(attachments) && attachments.length) {
        const wrap = document.createElement('div');
        wrap.className = 'attachments';
        attachments.forEach(att => {
          const card = document.createElement('div');
          card.className = 'attach-card';
          card.innerHTML = `
            <div class="attach-title">üìÑ <span>${att.title}</span></div>
            <div class="attach-meta">C√≥digo: ${att.code}</div>
            <div class="attach-actions">
              <a href="docs/${att.pdfId}" download target="_blank" rel="noopener">‚úîÔ∏è Descargar PDF</a>
            </div>
          `;
          wrap.appendChild(card);
        });
        bubble.appendChild(wrap);
      }

      row.appendChild(bubble);
      messagesEl.appendChild(row);
      scrollToBottom();
    }

    function sendUserMessage() {
      const raw = inputEl.value;
      const text = raw.trim();
      if (!text) return;

      // Render usuario
      renderMessage({ text: sanitize(text), sender: 'user' });

      // Limpiar y auto-resize
      inputEl.value = '';
      autoResizeTextarea(inputEl);

      // Componer respuesta de Valeria (motor de contexto integrado)
      try {
        const { replyHtml, attachments } = window.valeriaCraftReply(text);
        // Si replyHtml est√° vac√≠o pero hay adjuntos: modo "PDF directo"
        renderMessage({ html: replyHtml || '', sender: 'bot', attachments });
      } catch (e) {
        renderMessage({
          html: '‚ùó Ocurri√≥ un inconveniente al procesar la consulta. Prob√° de nuevo o especific√° el <b>producto</b> o <b>proceso</b> que quer√©s trabajar. üôÇ',
          sender: 'bot'
        });
        console.error(e);
      }
    }

    // Enviar con click o Enter (Shift+Enter = salto)
    sendBtn.addEventListener('click', sendUserMessage);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendUserMessage();
      }
    });

    // Sin saludo autom√°tico para no interferir en pruebas.
  </script>
  <!-- ==========================================================
       üß† Valeria Context Engine (Motor de comprensi√≥n e impl√≠citos)
       Integrado completo (sin parches aparte)
       ========================================================== -->
  <script>
  (function () {
    // -------------------------
    // Estado de sesi√≥n (ligero)
    // -------------------------
    const defaultState = {
      tema_actual: null,
      procedimiento_relevante: null,
      entidades: [],
      riesgo_detectado: null,
      ultimo_modo: null
    };
    window.__VALERIA_STATE = window.__VALERIA_STATE || { ...defaultState };

    // -------------------------
    // Utilidades
    // -------------------------
    const stripAccents = (s) => s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    const norm = (s) => stripAccents(String(s || '').toLowerCase().trim());

    // Normalizador (sin√≥nimos AR y errores comunes)
    const SYN = [
      // Productos
      { find: [/carne\s+vacuna/], to: 'carnes rojas' },
      { find: [/queso?s?/], to: 'quesos' },
      { find: [/lacteos?/], to: 'lacteos' },
      { find: [/milanesa?s?/], to: 'milanesas' },
      { find: [/dulce?s?|mermeladas?|confituras?/], to: 'dulces' },
      { find: [/pollo?s?/], to: 'pollo' },
      { find: [/ovina|cordero|carne\s+ovina/], to: 'carne ovina' },
      // Acciones
      { find: [/fraccion(ar|ado|amiento)/], to: 'fraccionar' },
      { find: [/etiquet(ar|ado)|rotul(ar|ado)/], to: 'etiquetar' },
      { find: [/sanitiz(ar|ante)|desinfect(ar|ante)/], to: 'sanitizar' },
      { find: [/retir(ar|o)|venc(e|imien)|vida util|aptitud/], to: 'retiro' },
      { find: [/embandej(ad|ar|ado)|ambandejado/], to: 'en bandeja' },
      // Insumos
      { find: [/lavandina|cloro/], to: 'lavandina' },
      { find: [/amonio\s+cuaternario|j-?512/], to: 'amonio cuaternario' },
      // Documentos / nociones
      { find: [/procedimiento|poe|instructivo/], to: 'procedimiento' },
      { find: [/plan\s+de\s+accion|plan\s+correctivo/], to: 'plan de accion' },
      { find: [/registro\s+de\s+sucursales/], to: 'registro de sucursales' }
    ];

    function normalizeTokens(text) {
      const t = norm(text);
      let out = t;
      SYN.forEach(({ find, to }) => {
        find.forEach((re) => { out = out.replace(re, to); });
      });
      return out.replace(/\s+/g,' ').trim();
    }

    // -------------------------
    // Cat√°logo de procedimientos (respetando nombres/rutas en docs/)
    // -------------------------
    const PROCEDURES = {
      'fraccionado_quesos': {
        title: 'Procedimiento de fraccionado de quesos',
        code: 'G-PG-QUESOS',
        tags: ['quesos', 'fraccionar', 'etiquetar', 'en bandeja', 'rotular'],
        summary: [
          'Mise en place higi√©nica y superficie sanitizada.',
          'Tiempo de exposici√≥n al ambiente: minimizar.',
          'Corte/porcionado y <b>etiquetado interno</b> (fecha fraccionado, vencimiento original, responsable).',
          'Almacenamiento en <b>refrigeraci√≥n</b>; FEFO/FIFO.'
        ],
        pdfId: 'proc_fraccionado_quesos.pdf'
      },
      'procedimiento_pollo': {
        title: 'Procedimiento de pollo',
        code: 'PROC-POLLO',
        tags: ['pollo', 'fraccionar', 'etiquetar', 'en bandeja'],
        summary: [
          'Higiene de manos, utensilios exclusivos, superficie sanitizada.',
          'Control de <b>temperaturas</b> y tiempos de exposici√≥n.',
          'Etiquetado interno (fecha/hora de fraccionado).',
          'Refrigeraci√≥n y segregaci√≥n por riesgo cruzado.'
        ],
        pdfId: 'proc_pollo.pdf'
      },
      'manejo_carne_ovina': {
        title: 'Procedimiento de manejo de carne ovina',
        code: 'PROC-OVINA',
        tags: ['carne ovina', 'fraccionar', 'etiquetar'],
        summary: [
          'Desposte/porcionado en √°rea autorizada.',
          'Control de T¬∞; evitar goteo y contaminaci√≥n cruzada.',
          'Etiquetado interno y trazabilidad por lote.'
        ],
        pdfId: 'proc_carne_ovina.pdf'
      },
      'procedimiento_milanesas': {
        title: 'Procedimiento de milanesas',
        code: 'PROC-MILA',
        tags: ['milanesas', 'fraccionar', 'etiquetar', 'en bandeja'],
        summary: [
          'Superficie sanitizada, utensilios exclusivos.',
          'Etiquetado con <b>fecha de elaboraci√≥n</b>; <b>m√°x. 48 h</b> en heladera.',
          'Separadores entre capas para evitar compactaci√≥n.'
        ],
        pdfId: 'proc_milanesas.pdf'
      },
      'fraccionado_dulces': {
        title: 'Procedimiento de fraccionado de dulces',
        code: 'PROC-DULCES',
        tags: ['dulces', 'fraccionar', 'etiquetar'],
        summary: [
          'Fraccionado con utensilios limpios y secos.',
          'Envases aptos y rotulados con lote y fecha.',
          'Evitar contaminaci√≥n por humedad.'
        ],
        pdfId: 'proc_dulces.pdf'
      },
      'medicion_sanitizante': {
        title: 'Medici√≥n de sanitizante (amonio cuaternario 200 ppm)',
        code: 'G-PG-007',
        tags: ['amonio cuaternario', 'sanitizar', 'medicion', 'mesada'],
        summary: [
          '<b>No usamos lavandina</b> en esta operaci√≥n.',
          'Preparar <b>J-512 a 200 ppm</b> seg√∫n instrucciones.',
          'Verificar concentraci√≥n con tiras/reactivo (G‚ÄëPG‚Äë007).'
        ],
        pdfId: 'G-PG-007_medicion_sanitizante.pdf'
      },
      'registro_sucursales': {
        title: 'Registro de sucursales',
        code: 'RG 01-SUC-ML-002',
        tags: ['registro de sucursales', 'registro', 'documento'],
        summary: [
          'Formato estandarizado de registro por sucursal.',
          'Completar campos obligatorios y firma responsable.'
        ],
        pdfId: 'RG_01-SUC-ML-002_registro_sucursales.pdf'
      },
      'plan_accion': {
        title: 'Plan de acci√≥n',
        code: 'PLAN-ACCION',
        tags: ['plan de accion', 'no conformidad', 'incidente'],
        summary: [
          'Acci√≥n inmediata y correctiva.',
          'An√°lisis de <b>causa ra√≠z</b> (5 porqu√©s, espina de pescado).',
          'Seguimiento y verificaci√≥n de efectividad.'
        ],
        pdfId: 'plan_de_accion.pdf'
      }
    };

    // -------------------------
    // Reglas internas clave (complementarias)
    // -------------------------
    const RULES = {
      sanitizante: {
        message: 'En esta operaci√≥n <b>no usamos lavandina</b>. Us√° <b>amonio cuaternario (J‚Äë512) a 200 ppm</b> y verific√° con tiras/reactivo conforme <b>G‚ÄëPG‚Äë007</b>.',
        tags: ['sanitizar', 'mesada', 'amonio cuaternario', 'medicion', '200 ppm']
      },
      retiro_anticipado: {
        message: 'Record√° <b>retiro anticipado</b>: <b>congelados/masivos</b> a <b>10 d√≠as</b> del vencimiento; <b>perecederos</b> a <b>2 d√≠as</b>.',
        tags: ['retiro', 'vencimiento', 'g√≥ndola', 'deposito']
      }
    };

    // -------------------------
    // Detecci√≥n de intenci√≥n + entidades
    // -------------------------
    function detectIntent(textN) {
      const intents = [];
      if (/\b(dame|pasame|mandame|enviame|mostrame)\s+el\s+procedimiento\b/.test(textN) ||
          /\b(dame|pasame|mandame|enviame|mostrame)\s+el\s+pdf\b/.test(textN) ||
          /\b(quiero|necesito)\s+el\s+procedimiento\b/.test(textN) ||
          /\b(quiero|necesito)\s+el\s+pdf\b/.test(textN) ||
          (/\b(pdf|procedimiento)\b/.test(textN) && textN.length <= 35)) {
        intents.push('pedido_pdf_directo');
        intents.push('solicitar_procedimiento');
      } else if (/\b(procedimiento|poe|instructivo)\b/.test(textN)) {
        intents.push('solicitar_procedimiento');
      }
      if (/\b(fraccionar|etiquetar|rotular|en bandeja|sanitizar|desinfectar)\b/.test(textN)) {
        intents.push('consulta_operativa');
      }
      if (/\b(venc|retir|retiro|fecha limite|fecha de vencimiento|vida util|aptitud)\b/.test(textN)) {
        intents.push('normativa');
      }
      if (/\b(incidente|olor|temperatura elevada|no conformidad|riesgo)\b/.test(textN)) {
        intents.push('riesgo');
      }
      if (!intents.length) intents.push('general');
      return intents;
    }

    const ENTITY_TERMS = [
      'quesos','pollo','carne ovina','carnes rojas','milanesas','dulces','lacteos',
      'mesada','amonio cuaternario','lavandina','en bandeja','etiquetar','fraccionar',
      'sanitizar','retiro','vencimiento','procedimiento','plan de accion','registro de sucursales'
    ];

    function extractEntities(textN) {
      const found = new Set();
      ENTITY_TERMS.forEach(k => { if (textN.includes(k)) found.add(k); });
      return Array.from(found);
    }

    function resolveTema(state, entities) {
      const products = ['quesos','pollo','carne ovina','carnes rojas','milanesas','dulces','lacteos'];
      const hit = entities.find(e => products.includes(e));
      return hit || state.tema_actual || null;
    }

    function guessProcedure(tema, intents, entities) {
      const has = (arr, key) => arr && arr.some(e => e === key);
      if (tema === 'quesos') return 'fraccionado_quesos';
      if (tema === 'pollo') return 'procedimiento_pollo';
      if (tema === 'carne ovina') return 'manejo_carne_ovina';
      if (tema === 'milanesas') return 'procedimiento_milanesas';
      if (tema === 'dulces') return 'fraccionado_dulces';
      if (has(entities, 'amonio cuaternario') || has(entities, 'sanitizar') || has(entities, 'mesada')) {
        return 'medicion_sanitizante';
      }
      if (has(entities, 'registro de sucursales')) return 'registro_sucursales';
      if (intents.includes('riesgo')) return 'plan_accion';
      return null;
    }

    function attachmentCard(proc) {
      return {
        title: `${proc.title}`,
        code: proc.code,
        pdfId: proc.pdfId
      };
    }

    function renderBullets(lines) {
      return lines.map(l => `‚Ä¢ ${l}`).join('<br>');
    }

    function buildReply({ intents, tema, procedureKey, textN }) {
      const parts = [];
      const attachments = [];

      const needsSanitizante = /sanitizar|mesada|amonio cuaternario/.test(textN);
      const needsRetiro = /retiro|venc|vida util|aptitud/.test(textN);

      // Procedimiento principal (si existe y NO es pedido directo)
      if (procedureKey && !intents.includes('pedido_pdf_directo')) {
        const proc = PROCEDURES[procedureKey];
        if (proc) {
          parts.push(`üîé Tema: <b>${tema || 'general'}</b>`);
          parts.push(`<b>üìã ${proc.title}</b><br>${renderBullets(proc.summary)}`);
          attachments.push(attachmentCard(proc));
        }
      }

      // Si no hubo procedimiento pero hay intenci√≥n operativa y no es pedido directo
      if (!procedureKey && intents.includes('consulta_operativa') && !intents.includes('pedido_pdf_directo')) {
        parts.push('Entiendo que necesit√°s una <b>indicaci√≥n operativa</b>. ¬øSobre qu√© producto/√°rea (p. ej., <b>quesos</b>, <b>pollo</b>, <b>mesada</b>) te doy el paso a paso exacto? üôÇ');
      }

      // Reglas sanitizante (complemento)
      if (needsSanitizante && !intents.includes('pedido_pdf_directo')) {
        parts.push(`üßº ${RULES.sanitizante.message}`);
        attachments.push(attachmentCard(PROCEDURES['medicion_sanitizante']));
      }

      // Regla retiro/aptitud (complemento)
      if (needsRetiro && !intents.includes('pedido_pdf_directo')) {
        parts.push(`‚è±Ô∏è ${RULES.retiro_anticipado.message}`);
        attachments.push(attachmentCard(PROCEDURES['plan_accion']));
      }

      // Ayuda por defecto
      if (!parts.length && !intents.includes('pedido_pdf_directo')) {
        parts.push('Estoy para ayudarte en <b>inocuidad alimentaria</b> (CAA, BPM y procedimientos internos). Decime el <b>producto</b> o el <b>proceso</b> y te doy el paso a paso + PDF. ‚ú®');
      }

      const replyHtml = parts.join('<br><br>');
      return { replyHtml, attachments };
    }

    function processTurn({ userText, state }) {
      const safeState = { ...defaultState, ...(state || {}) };
      const textN = normalizeTokens(userText);

      // 1) Intenci√≥n y entidades
      const intents = detectIntent(textN);
      const entities = extractEntities(textN);

      // 2) Resolver tema (conserva el √∫ltimo si no hay nuevo)
      let tema = resolveTema(safeState, entities);

      // 3) Adivinar procedimiento principal
      let procedureKey = guessProcedure(tema, intents, entities);

      // 4) Si pidi√≥ procedimiento/PDF y no hay tema, usar el de sesi√≥n si existe
      if (!procedureKey && intents.includes('solicitar_procedimiento') && safeState.tema_actual) {
        tema = safeState.tema_actual;
        procedureKey = guessProcedure(tema, intents, entities);
      }

      // 5) Construir respuesta preliminar
      let { replyHtml, attachments } = buildReply({ intents, tema, procedureKey, textN });

      // 6) **Modo PDF directo**: ante pedido expl√≠cito => SOLO PDF
      if (intents.includes('pedido_pdf_directo')) {
        // Si no hay procedimiento todav√≠a, intentamos inferirlo con tema actual
        if (!procedureKey && tema) {
          procedureKey = guessProcedure(tema, intents, entities);
        }
        // Si lo tenemos, adjuntamos SOLO ese PDF (sin texto)
        if (procedureKey) {
          const proc = PROCEDURES[procedureKey];
          attachments = [attachmentCard(proc)];
          replyHtml = ''; // sin rodeos
        } else {
          // Sin contexto suficiente: pedir 1 dato cr√≠tico m√≠nimo
          attachments = [];
          replyHtml = 'Para enviarte el <b>PDF</b> directo, decime el <b>producto o proceso</b> (p. ej., <b>quesos</b>, <b>pollo</b>, <b>mesada</b>).';
        }
      }

      // 7) Actualizar estado de sesi√≥n
      safeState.tema_actual = tema || safeState.tema_actual || null;
      safeState.procedimiento_relevante = procedureKey || safeState.procedimiento_relevante || null;
      safeState.entidades = Array.from(new Set([...(safeState.entidades || []), ...entities]));

      return { replyHtml, attachments, state: safeState };
    }

    // API p√∫blica para la UI
    window.valeriaCraftReply = function(userText) {
      const out = processTurn({ userText, state: window.__VALERIA_STATE });
      window.__VALERIA_STATE = out.state;
      return out;
    };
  })();
  </script>

</body>
</html>
