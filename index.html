<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover, interactive-widget=resizes-content" name="viewport"/>
<meta content="#0a2f73" name="theme-color"/>
<link href="/manifest.webmanifest" rel="manifest"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="default" name="apple-mobile-web-app-status-bar-style"/>
<title>Valeria ¬∑ Seguridad Alimentaria</title>
<meta content="Asistente Valeria - Seguridad Alimentaria (Argentina)" name="description"/>
<!-- Favicons opcionales -->
<link href="/icons/valeria-32.png" rel="icon" sizes="32x32" type="image/png"/>
<link href="/icons/valeria-192.png" rel="icon" sizes="192x192" type="image/png"/>
<link href="/icons/valeria-512.png" rel="icon" sizes="512x512" type="image/png"/>
<link href="/icons/valeria-180.png" rel="apple-touch-icon" sizes="180x180"/>
<link color="#0a2f73" href="/icons/valeria-maskable.svg" rel="mask-icon"/>
<!-- Fallback si no est√°n los √≠conos a√∫n -->
<link href="/valeria-mini.jpg" rel="icon">
<!-- v-2025.08.01-definitivo + contexto -->
<style>
    :root{
      --brand-blue:#0a2f73; --header-bg:var(--brand-blue); --header-fg:#fff;
      --page-bg:#eef1f6; --chat-bg:#f5f7fb; --text:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --bubble-bot:#dbeafe; --bubble-bot-text:#0f172a;
      --bubble-user:#eef2f7; --bubble-user-text:#0f172a;
      --fs-body:clamp(15px,1.6vw,16px); --fs-name:clamp(18px,3vw,22px); --fs-role:clamp(12px,2vw,14px);
      --header-h:56px; --vhpx:100svh;
      /* Adjunto compacto */
      --attach-bg:#ffffff; --attach-bd:#d9e1f2; --attach-fg:#0f172a; --attach-bg-hover:#f3f6ff;
    }
    [data-theme="dark"]{
      --header-bg:var(--brand-blue); --header-fg:#e5e7eb;
      --page-bg:#0f172a; --chat-bg:#0b1220; --text:#e5e7eb; --muted:#9ca3af; --border:#1f2937;
      --bubble-bot:#1b2d50; --bubble-bot-text:#e5e7eb;
      --bubble-user:#335694; --bubble-user-text:#e5e7eb;

      --attach-bg:#0f172a; --attach-bd:#344465; --attach-fg:#e5e7eb; --attach-bg-hover:#132042;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--page-bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-size:var(--fs-body); line-height:1.55; padding-top:env(safe-area-inset-top,0);
      overflow:hidden;
    }

    /* ===== App a pantalla completa (takeover) ===== */
    #valeria-app{
      position:fixed; inset:0; z-index:1;
      display:flex; flex-direction:column; background:var(--page-bg);
    }

    /* Header fijo */
    header{
      display:flex; align-items:center; gap:10px;
      height:var(--header-h);
      padding:max(8px,env(safe-area-inset-top)) 12px 8px 12px;
      background:var(--header-bg); color:var(--header-fg);
      border-bottom:1px solid rgba(255,255,255,.15);
      z-index:20; transform:translateZ(0);
    }
    @media (min-width:768px){ :root{--header-h:64px} header{ padding:12px 16px } }

    .avatar-wrap{
      width:40px;height:40px;border-radius:999px;overflow:hidden;flex:0 0 auto;
      background:#fff url('/valeria-mini.jpg') center/cover no-repeat; box-shadow:0 2px 8px rgba(0,0,0,.12);
      cursor:zoom-in; user-select:none;
    }
    @media (min-width:768px){ .avatar-wrap{width:44px;height:44px} }
    .title{display:flex;flex-direction:column;line-height:1.1;min-width:0}
    .name{font-weight:800;font-size:var(--fs-name);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .role{font-weight:600;font-size:var(--fs-role);opacity:.95;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .spacer{flex:1 1 auto}
    .themebtn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:999px;border:1px solid rgba(255,255,255,.25);background:transparent;color:var(--header-fg);cursor:pointer}
    .themebtn svg{width:20px;height:20px}

    /* Main ocupa lo restante */
    main{ flex:1 1 auto; min-height:0; }
    .wrap{width:100%;max-width:980px;margin:0 auto;padding:8px 8px 12px; height:100%}

    /* Chat: grid 1fr + auto */
    .chat{
      height:100%;
      background:var(--chat-bg); border:1px solid var(--border); border-radius:16px; box-shadow:0 6px 18px rgba(15,23,42,.06);
      display:grid; grid-template-rows:1fr auto; overflow:hidden; contain:layout size style;
    }

    /* Mensajes */
    .msgs{
      overflow:auto; display:flex; flex-direction:column; gap:10px; padding:12px 10px; -webkit-overflow-scrolling:touch;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(255,255,255,.35) 0%, rgba(255,255,255,0) 60%),
        radial-gradient(900px 500px at 120% 20%, rgba(255,255,255,.25) 0%, rgba(255,255,255,0) 60%);
      contain:strict;
    }
    [data-theme="dark"] .msgs{
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(255,255,255,.06) 0%, rgba(255,255,255,0) 60%),
        radial-gradient(900px 500px at 120% 20%, rgba(255,255,255,.05) 0%, rgba(255,255,255,0) 60%);
    }

    .row{display:flex;gap:6px;align-items:flex-end}
    .row.user{justify-content:flex-end}
    .bubble{
      max-width:78%; padding:10px 12px; border-radius:16px; white-space:pre-wrap;
      border:1px solid var(--border); word-wrap:break-word; box-shadow:0 1px 2px rgba(0,0,0,.04);
      overflow-wrap:anywhere;
    }
    .user .bubble{background:var(--bubble-user);color:var(--bubble-user-text)}
    .bot  .bubble{background:var(--bubble-bot); color:var(--bubble-bot-text)}
    .bubble strong{font-weight:800} .bubble em{font-style:italic}
    .bubble p{margin:0 0 8px} .bubble p:last-child{margin:0}
    .bubble img{ max-width:100%; height:auto; border-radius:8px; display:block; }

    /* Composer */
    .composer{ display:flex; align-items:flex-end; gap:8px; padding:8px; border-top:1px solid var(--border); background:#fff; }
    [data-theme="dark"] .composer{ background:#0b1220; }
    .textarea-wrap{ flex:1; display:flex; align-items:center; padding:6px 12px; border:1px solid var(--border); border-radius:22px; background:#fff; }
    [data-theme="dark"] .textarea-wrap{ background:#0f172a; border-color:#374151; }
    textarea{ flex:1; resize:none; border:0; background:transparent; color:var(--text); font:inherit; line-height:1.55;
      min-height:24px; max-height:9.5em; padding:6px 0; outline:none }
    textarea::placeholder{ color:#94a3b8 }
    .sendbtn{ display:inline-flex;align-items:center;justify-content:center;background:var(--brand-blue);color:#fff;border:0;width:44px;height:44px;border-radius:999px;cursor:pointer;transition:transform .05s, filter .2s }
    .sendbtn:active{ transform:scale(.98) } .sendbtn:hover{ filter:brightness(1.05) } .sendbtn svg{ width:20px;height:20px }

    /* === Adjunto compacto: respeta ancho de la burbuja === */
    .attach{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px;
      font-size:13px; font-weight:700; text-decoration:none;
      background:var(--attach-bg); color:var(--attach-fg);
      border:1px solid var(--attach-bd);
      max-width:100%;
      white-space:nowrap;
    }
    .attach:hover{ background: var(--attach-bg-hover); }
    .attach .clip{ font-size:14px; line-height:1; flex:0 0 auto; }
    .attach .name{ min-width:0; flex:1 1 auto; overflow:hidden; text-overflow:ellipsis; }

    /* Viewer imagen (con frase adentro) */
    .viewer{
      position:fixed; inset:0; z-index:50; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.52);
      padding:max(16px,env(safe-area-inset-top)) max(16px,env(safe-area-inset-right)) max(16px,env(safe-area-inset-bottom)) max(16px,env(safe-area-inset-left));
      flex-direction:column; gap:12px;
    }
    .viewer.open{ display:flex; }
    .viewer img{
      max-width: min(92vw, 1024px);
      max-height: 78vh;
      border-radius:12px; object-fit: contain; box-shadow:0 10px 40px rgba(0,0,0,.4);
      background:#fff;
    }
    .viewer .motto{
      color:#fff; font-size:14px; text-align:center; font-weight:600; max-width:90%; line-height:1.35;
      text-shadow:0 1px 2px rgba(0,0,0,.45);
    }
  </style>
</link></head>
<body>
<div id="valeria-app">
<header>
<div class="avatar-wrap" id="avatarWrap" title="Ver imagen"></div>
<div class="title"><div class="name">Valeria</div><div class="role">Seguridad Alimentaria</div></div>
<div class="spacer"></div>
<button aria-label="Cambiar tema" class="themebtn" id="themeToggle" title="Cambiar tema">
<svg aria-hidden="true" fill="none" id="themeIcon" stroke="currentColor" viewbox="0 0 24 24">
<circle cx="12" cy="12" r="5" stroke-width="2"></circle>
<path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke-width="2"></path>
</svg>
</button>
</header>
<!-- Visor de imagen -->
<div aria-modal="true" class="viewer" id="viewer" role="dialog" tabindex="-1">
<img alt="Valeria" src="/valeria-full.jpg"/>
<div class="motto">üõ°Ô∏è La inocuidad alimentaria comienza con cada decisi√≥n que tomamos.</div>
</div>
<main>
<div class="wrap">
<div class="chat">
<div class="msgs" id="msgs"></div>
<div class="composer" id="composer">
<div class="textarea-wrap"><textarea id="box" placeholder="Mensaje"></textarea></div>
<button aria-label="Enviar" class="sendbtn" id="send">
<svg fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M5 12L3 4l18 8-18 8 2-8zm0 0l7 0" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>
</div>
</div>
</main>
</div>
<script>
    const $ = s => document.querySelector(s);
    const msgs=$('#msgs'), box=$('#box'), btn=$('#send'), themeToggle=$('#themeToggle'), themeIcon=$('#themeIcon'), composer=$('#composer');

    /* ===================== Tema (d√≠a/noche) ===================== */
    const storageKey='valeria_theme';
    function applyTheme(theme){
      const prefersDark=window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      if(theme==='dark'){document.documentElement.setAttribute('data-theme','dark');}
      else if(theme==='light'){document.documentElement.removeAttribute('data-theme');}
      else{ prefersDark?document.documentElement.setAttribute('data-theme','dark'):document.documentElement.removeAttribute('data-theme'); }
      themeIcon.innerHTML=(document.documentElement.getAttribute('data-theme')==='dark')
        ?'<path d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z" stroke-width="2" fill="none"/>'
        :'<circle cx="12" cy="12" r="5" stroke-width="2"></circle><path stroke-width="2" d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>';
    }
    function currentTheme(){const t=localStorage.getItem(storageKey);return(t==='light'||t==='dark')?t:null;}
    function toggleTheme(){const t=currentTheme();const next=t==='dark'?'light':'dark';localStorage.setItem(storageKey,next);applyTheme(next);}
    applyTheme(currentTheme());
    themeToggle.addEventListener('click', toggleTheme);
    if(window.matchMedia){window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',()=>{if(currentTheme()===null)applyTheme(null);});}

    /* ===================== Viewport (iOS/Android) ===================== */
    function setVH(){
      const vv=window.visualViewport;
      const h=vv ? vv.height : (window.innerHeight||document.documentElement.clientHeight);
      document.documentElement.style.setProperty('--vhpx', h + 'px');
    }
    function reflow(){ setVH(); msgs.scrollTop = msgs.scrollHeight; }
    function setupViewportListeners(){
      reflow();
      window.addEventListener('resize', reflow, {passive:true});
      window.addEventListener('orientationchange', reflow, {passive:true});
      if(window.visualViewport){
        visualViewport.addEventListener('resize', reflow, {passive:true});
        visualViewport.addEventListener('scroll', reflow, {passive:true});
      }
      const ro=new ResizeObserver(()=>{ msgs.scrollTop = msgs.scrollHeight; });
      ro.observe(composer);
    }
    setupViewportListeners();

    /* ===================== Autosize textarea ===================== */
    function autosizeTextarea(){
      box.style.height='auto';
      const lineH=parseFloat(getComputedStyle(box).lineHeight)||20;
      const max=lineH*6 + 12;
      box.style.height=Math.min(box.scrollHeight,max)+'px';
      msgs.scrollTop=msgs.scrollHeight;
    }
    box.addEventListener('input', autosizeTextarea);
    box.addEventListener('focus', ()=>{ setTimeout(()=>{ autosizeTextarea(); msgs.scrollTop=msgs.scrollHeight; }, 50); });

    /* ===================== Helpers UI (emojis/negritas) ===================== */
    function escapeHTML(s){return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}
    function injectWhatsAppEmojis(html){
      const patterns=[
        {rx:/\bpdf\b/i,emoji:'üìÑ'},{rx:/\bprocedimiento(s)?\b/i,emoji:'üìã'},
        {rx:/\bsanitizante|j-?512|amonio cuaternario\b/i,emoji:'üß™'},{rx:/\b200\s*ppm\b/i,emoji:'üß™'},
        {rx:/\bfefo\b/i,emoji:'üîÅ'},{rx:/\betiquet(ad|ad)o|rotulado\b/i,emoji:'üè∑Ô∏è'},
        {rx:/\bauditor(i|√≠)a(s)?\b/i,emoji:'üîé'},{rx:/\btemperatura|fr[i√≠]o|heladera|c[a√°]mara\b/i,emoji:'üå°Ô∏è'},
        {rx:/\bcorrect(o|a)s?\b/i,emoji:'‚úÖ'},{rx:/\bincorrect(o|a)s?\b/i,emoji:'‚ùå'},
        {rx:/\bimportante\b/i,emoji:'‚≠ê'},{rx:/\btiempo|minut(o|os)\b/i,emoji:'‚è±Ô∏è'},
        {rx:/\bqueso(s)?|fraccionamiento de quesos\b/i,emoji:'üßÄ'}
      ];
      for(const {rx,emoji} of patterns){ html=html.replace(rx,(m)=>`${emoji} ${m}`); }
      return html;
    }
    function formatReply(text){
      if(!text)return''; let out=escapeHTML(text);
      out=out.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
      const emph=[/(\b200\s*ppm\b)/gi,/\b(j-?512|amonio cuaternario|sanitizante)\b/gi,/\b(bpm|bpa|poes|mip|5s)\b/gi,/\b(fefo)\b/gi,/\b(retiro anticipado|pr[o√≥]ximo a vencer)\b/gi,/\b(auditor[i√≠]a[s]?|registro[s]?)\b/gi,/\b(acciones inmediatas|acciones preventivas|procedimiento)\b/gi];
      emph.forEach(rx=>{out=out.replace(rx,'<strong>$1</strong>');});
      out=out.replace(/^(\s*\**\s*Acciones inmediatas\s*\**)/gim,'‚úÖ <strong>$1</strong>')
             .replace(/^(\s*\**\s*Acciones preventivas\s*\**)/gim,'üõ°Ô∏è <strong>$1</strong>')
             .replace(/^(\s*\**\s*Procedimiento\s*\**)/gim,'üìã <strong>$1</strong>')
             .replace(/^(\s*\**\s*An√°lisis de causa ra√≠z.*)/gim,'üîé <strong>$1</strong>');
      out=out.split('\n\n').map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('');
      out=injectWhatsAppEmojis(out);
      return out;
    }
    function isGreeting(text){
      const t=(text||'').trim().toLowerCase();
      return /^hola([ !,.¬ø?]|$)/.test(t) || /^buen(d[i√≠]a|as tardes|as noches)/.test(t);
    }

    /* ===================== CONTEXTO (tema activo) ===================== */
    let lastTopic = null;
    const TOPIC_KEYS = [
      { rx: /\bques(o|os)\b|\bfraccionamiento de quesos?\b/i, topic: 'fraccionamiento de quesos', pdfKey: 'fraccionamiento de quesos' },
      { rx: /\bsanitizante\b|\bj-?512\b|\b200\s*ppm\b/i, topic: 'sanitizante j-512', pdfKey: 'j-512' },
      { rx: /\brotulad(o|a)|etiquetado\b/i, topic: 'rotulado/etiquetado', pdfKey: 'rotulado' },
      { rx: /\bfefo\b/i, topic: 'FEFO', pdfKey: 'fefo' },
      { rx: /\bpoes\b|\bmip\b|\bbpm\b/i, topic: 'POES/BPM/MIP', pdfKey: 'poes' }
      // Pod√©s sumar m√°s
    ];
    function detectTopic(text){
      const s = (text||'');
      for (const {rx, topic, pdfKey} of TOPIC_KEYS){
        if (rx.test(s)) return { topic, pdfKey };
      }
      return null;
    }
    function updateTopicFromText(text){
      const hit = detectTopic(text);
      if (hit) lastTopic = hit; // {topic, pdfKey}
    }
    function resolveImplicitRequest(userText){
      const t = (userText || '').toLowerCase().trim();
      const wantsProcedure = /^(dame|pasame|enviame|mandame)\s+(el\s+)?procedimiento(s)?\b/i.test(t)
                           || /^procedimiento(s)?$/i.test(t);
      if (wantsProcedure && lastTopic){
        if (!t.includes(lastTopic.topic)) return `${userText} de ${lastTopic.topic}`;
      }
      return userText;
    }
    function deGenericize(reply){
      if (!reply || !lastTopic) return reply;
      const askArea = /(indic(a|√°)me|decime|dime|por favor ind(i|√≠)ca)\s+cu[a√°]l\s+es\s+el\s+(tema|√°rea)[^.\n]*[.\n]?/i;
      if (askArea.test(reply)){
        const hint = `Te comparto el procedimiento de ${lastTopic.topic}.`;
        reply = reply.replace(askArea, hint + ' ');
      }
      return reply;
    }

    /* ===================== Historial corto (opcional) ===================== */
    const history = []; // {role:'user'|'assistant', content:'...'}
    function pushHistory(role, content){
      history.push({ role, content });
      if (history.length > 12) history.shift(); // ~6 turnos
    }

    /* ===================== Mensajer√≠a (UI) ===================== */
    let interacted=false;
    function addMsg(role,text){
      const row=document.createElement('div'); row.className=`row ${role}`;
      const bubble=document.createElement('div'); bubble.className='bubble';
      if(role==='bot'){
        let t=String(text||'');
        if(isGreeting(t)) t = 'üëã ' + t.replace(/^hola/i,'Hola').trim();
        bubble.innerHTML=formatReply(t);
      } else {
        bubble.textContent=text;
      }
      row.appendChild(bubble); msgs.appendChild(row);
      msgs.scrollTop=msgs.scrollHeight;
      return row;
    }
    function mark(){interacted=true;}
    box.addEventListener('keydown',mark); box.addEventListener('focus',mark); btn.addEventListener('click',mark);
    setTimeout(()=>{ if(!interacted && !msgs.querySelector('.row.user')) addMsg('bot','Hola, soy Valeria. ¬øEn qu√© te puedo ayudar para fortalecer la cultura de inocuidad?'); },5000);

    /* ===================== PDFs (misma l√≥gica + sesgo por tema) ===================== */
    async function ensurePdfMap(){ try{const r=await fetch('/docs/keyword_to_file.json',{cache:'no-store'}); return r.ok?await r.json():{}; }catch{return{};} }
    function wantsPdf(t){t=(t||'').toLowerCase();return t.includes('pdf')||t.includes('adjunto')||t.includes('documento');}
    const PRIORITY_KEYS=['sanitizante','j-512','j512','200 ppm','amonio cuaternario','amonio','fefo','retiro anticipado','proximo a vencer','rotulado','etiquetado','fraccionamiento de quesos','quesos','queso','milanesas','pollo','carne vacuna','carne ovina','poes','bpm','bpa','mip','5s','reclamos','retiro de mercado'];
    function bestMatch(txt,map){
      const t=(txt||'').toLowerCase();
      for(const k of PRIORITY_KEYS){if(map[k]&&t.includes(k.toLowerCase()))return map[k];}
      const keys=Object.keys(map).sort((a,b)=>b.length-a.length);
      for(const k of keys){if(t.includes(k.toLowerCase()))return map[k];}
      return 'index.html';
    }
    async function fileExists(url){try{const r=await fetch(url,{method:'HEAD',cache:'no-store'});return r.ok;}catch{return false;}}

    /* ===================== Limpieza m√≠nima de respuestas ===================== */
    function cleanReply(text){
      if(!text) return text;
      let out=text;
      [ /verific(a|√°)\s+en\s+la\s+ra[i√≠]z[^.\n]*[.\n]?/gi, /revisa(r)?\s+la\s+ra[i√≠]z[^.\n]*[.\n]?/gi,
        /busc(a|√°)rlo\s+en\s+la\s+ra[i√≠]z[^.\n]*[.\n]?/gi, /en\s+el\s+servicio\s+de\s+almacenamiento\s+seguro[^.\n]*[.\n]?/gi,
        /no\s+puedo\s+enviar\s+archivos[^.\n]*[.\n]?/gi
      ].forEach(rx=>out=out.replace(rx,''));
      out = out.replace(/\bespecialista en seguridad alimentaria\b(?:\s*,?\s*especialista en seguridad alimentaria\b)+/gi,'especialista en seguridad alimentaria');
      out = out.replace(/\b(\w+)(?:[,\s]+)\1\b/gi, '$1'); // duplicaci√≥n accidental
      out = out.replace(/Licenciada\s+en\s+Tecnolog[i√≠]a\s+de\s+los\s+Alimentos/gi,'especialista en seguridad alimentaria');
      out = out.replace(/\n{3,}/g,'\n\n').trim();
      if(!out) out = "Aqu√≠ tienes el material solicitado:";
      return out;
    }

    /* ===================== Env√≠o ===================== */
    async function sendMessage(){
      let text=box.value.trim(); if(!text) return;

      // 1) UI muestra lo que escribi√≥ el usuario
      addMsg('user',text);
      updateTopicFromText(text);
      pushHistory('user', text);

      // 2) Expandir pedido impl√≠cito usando tema activo
      const expanded = resolveImplicitRequest(text);

      box.value=''; autosizeTextarea(); btn.disabled=true;

      try{
        const res=await fetch('/.netlify/functions/chat',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            message: expanded,           // ‚Üê lo que realmente pedimos al modelo
            context_hint: lastTopic,     // ‚Üê opcional (si tu backend lo utiliza)
            history                      // ‚Üê opcional (si se ignora, no afecta)
          })
        });

        if(!res.ok){
          const t=await res.text().catch(()=> '');
          addMsg('bot',`‚ö†Ô∏è Error del servidor (${res.status}). ${t.slice(0,200)}`);
          pushHistory('assistant', `Error ${res.status}`);
          return;
        }

        const data=await res.json().catch(()=> ({}));
        let reply = cleanReply(data.reply || data.answer || '');

        // 3) Si el modelo pidi√≥ "indicame el √°rea/tema..." pero hay contexto, lo resolvemos
        reply = deGenericize(reply);

        const userWantsPdf = wantsPdf(text);

        if(reply){
          const botRow=addMsg('bot',reply);
          updateTopicFromText(reply);
          pushHistory('assistant', reply);

          // 4) PDF: priorizamos el tema activo si existe
          if(userWantsPdf){
            const map=await ensurePdfMap();
            let chosen;
            if (lastTopic && lastTopic.pdfKey && map[lastTopic.pdfKey]) {
              chosen = map[lastTopic.pdfKey];
            } else {
              chosen = bestMatch(text, map);
            }
            const isIndex=String(chosen||'').toLowerCase()==='index.html';
            const url=isIndex?'/docs/index.html':`/docs/${chosen}`;
            const ok=await fileExists(url);

            const prettyName=(isIndex?'Ver Todos Los PDFs'
              : String(chosen||'').replace(/[-_]/g,' ').replace(/\.pdf$/i,'').replace(/\s+/g,' ').trim()
            ).replace(/\b\w/g,c=>c.toUpperCase());

            const bubble=botRow.querySelector('.bubble');
            bubble.appendChild(document.createElement('br'));
            const a=document.createElement('a');
            a.href = ok ? url : '/docs/index.html';
            a.target = '_blank'; a.rel='noopener';
            a.className = 'attach';
            a.innerHTML = `<span class="clip">üìé</span><span class="name">${prettyName}</span>`;
            bubble.appendChild(a);
          }

        }else{
          addMsg('bot','No lleg√≥ texto en "reply" ni en "answer". Verific√° en Network ‚Üí Response.');
          pushHistory('assistant', 'Respuesta vac√≠a');
        }
      }catch(e){
        addMsg('bot','‚ùå Error de red. ¬øEst√°s online?');
        pushHistory('assistant', 'Error de red');
      }finally{
        btn.disabled=false;
        msgs.scrollTop=msgs.scrollHeight;
      }
    }
    btn.addEventListener('click',sendMessage);
    box.addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

    /* ===================== Viewer imagen ===================== */
    const viewer=document.getElementById('viewer');
    document.getElementById('avatarWrap').addEventListener('click',()=>{viewer.classList.add('open');document.body.style.overflow='hidden';});
    viewer.addEventListener('click',()=>{viewer.classList.remove('open');document.body.style.overflow='';});
  </script>
<script>
let presentacionHecha = false;
let saludoEsperado = true;

const mensajesFueraDeTema = [
  "aconcagua", "d√≥lar", "clima", "geograf√≠a", "turismo", "historia", "astronom√≠a"
];

const respuestasPDF = {
  "sanitizante": "docs/sanitizante.pdf",
  "dulce": "docs/dulce.pdf",
  "queso": "docs/queso.pdf"
};

function contienePalabraClave(mensaje, claves) {
  return claves.some(p => mensaje.toLowerCase().includes(p));
}

function detectarPDF(mensaje) {
  const keys = Object.keys(respuestasPDF);
  for (const k of keys) {
    if (mensaje.toLowerCase().includes(k) &&
        contienePalabraClave(mensaje, ["procedimiento", "documento", "pdf", "entregame", "dame"])) {
      return respuestasPDF[k];
    }
  }
  return null;
}

function simularRespuesta(mensaje) {
  mensaje = mensaje.toLowerCase();
  if (contienePalabraClave(mensaje, mensajesFueraDeTema)) {
    return "üõë Lo siento, solo respondo consultas sobre seguridad alimentaria, BPM, CAA y procedimientos internos.";
  }

  const pdf = detectarPDF(mensaje);
  if (pdf) {
    return `üìÑ Aqu√≠ ten√©s el procedimiento solicitado: <a href="${pdf}" target="_blank">Descargar PDF</a> ‚úîÔ∏è`;
  }

  return null;
}

// Presentaci√≥n autom√°tica
setTimeout(() => {
  if (!presentacionHecha && saludoEsperado) {
    presentacionHecha = true;
    agregarMensaje("üë©üèª‚Äç‚öïÔ∏è Hola, soy Valeria, especialista en seguridad alimentaria. ¬øEn qu√© te puedo ayudar hoy?");
  }
}, 5000);

// Captura de mensajes
const input = document.getElementById("user-input");
const form = document.getElementById("chat-form");
form.addEventListener("submit", function(e) {
  saludoEsperado = false;
  const texto = input.value.trim();
  const respuestaCustom = simularRespuesta(texto);
  if (respuestaCustom) {
    agregarMensaje(respuestaCustom, false);
    input.value = "";
    e.preventDefault();
  }
});
</script></body>
</html>
